<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Goobusters</title>
    <link rel="stylesheet" href="/static/css/viewer.css">
    <style>
        .setup-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .setup-card {
            background: #2a2a2a;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
        }
        .setup-card h1 {
            margin: 0 0 0.5rem 0;
            color: #4CAF50;
            font-size: 1.5rem;
        }
        .setup-card p {
            color: #aaa;
            margin: 0 0 1.5rem 0;
            font-size: 0.9rem;
        }
        .setup-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
            font-size: 0.9rem;
        }
        .setup-form input,
        .setup-form select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .setup-form input:focus,
        .setup-form select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .setup-form select {
            cursor: pointer;
        }
        .setup-btn {
            width: 100%;
            padding: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }
        .setup-btn:hover {
            background: #45a049;
        }
        .setup-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .setup-status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            display: none;
        }
        .setup-status.info {
            display: block;
            background: #1a3a5c;
            color: #6ab0ff;
        }
        .setup-status.error {
            display: block;
            background: #5c1a1a;
            color: #ff6a6a;
        }
        .setup-status.success {
            display: block;
            background: #1a5c2a;
            color: #6aff8a;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .help-text {
            font-size: 0.8rem;
            color: #888;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-card">
            <h1>Welcome to Goobusters</h1>
            <p>Enter your details to sync the annotation dataset from MD.ai</p>
            
            <form class="setup-form" id="setupForm">
                <label for="userEmail">Your Name</label>
                <select id="userEmail" required>
                    <option value="" disabled selected>Select your name...</option>
                    <option value="Aaron">Aaron</option>
                    <option value="Christopher">Christopher</option>
                    <option value="Faezeh">Faezeh</option>
                    <option value="Kush">Kush</option>
                    <option value="Newton">Newton</option>
                </select>
                <p class="help-text">Used to track who made annotations</p>

                <label for="mdaiToken">MD.ai API Token</label>
                <input type="password" id="mdaiToken" placeholder="Paste your MD.ai token" required>
                <p class="help-text">Get your token from MD.ai Settings â†’ API</p>
                
                <button type="submit" class="setup-btn" id="setupBtn">
                    Save & Continue
                </button>
            </form>
            
            <div class="setup-status" id="statusBox"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('setupForm');
        const btn = document.getElementById('setupBtn');
        const status = document.getElementById('statusBox');
        
        function showStatus(message, type) {
            status.className = 'setup-status ' + type;
            status.innerHTML = message;
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('userEmail').value.trim();
            const token = document.getElementById('mdaiToken').value.trim();
            
            if (!email || !token) {
                showStatus('Please fill in all fields', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Setting up...';
            
            try {
                // Step 1: Save settings (no extra spinner - button already has one)
                
                const settingsResp = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_email: email,
                        mdai_token: token
                    })
                });
                
                if (!settingsResp.ok) {
                    const err = await settingsResp.json();
                    throw new Error(err.error || 'Failed to save settings');
                }
                
                // Credentials saved - redirect immediately to main viewer
                // The app startup sync will handle syncing (and show this modal again if sync fails)
                window.location.href = '/';
                
            } catch (err) {
                showStatus('Error: ' + err.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'Save & Continue';
            }
        });
    </script>
</body>
</html>
