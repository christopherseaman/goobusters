<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Goobusters</title>
    <link rel="stylesheet" href="/static/css/viewer.css">
</head>
<body>
    <!-- Dataset version mismatch warning -->
    <div id="datasetWarning" class="dataset-warning hidden">
        ‚ö† Dataset on this client may be out of sync with the server. Run client dataset sync before trusting masks.
    </div>

    <!-- Multiplayer warning banner -->
    <div id="multiplayerWarning" class="multiplayer-warning hidden"></div>

    <!-- Server connection warning banner (non-blocking, shown after initial connection) -->
    <div id="serverConnectionWarning" class="server-connection-warning hidden">
        ‚ö† Lost connection to server. Edits are saved locally. <button id="reconnectServerBtn" class="reconnect-btn">Reconnect</button>
    </div>

    <!-- Server connection blocking screen (shown before first successful connection) -->
    <div id="serverConnectionScreen" class="server-connection-screen">
        <div class="server-connection-content">
            <div id="serverConnectionSpinner" class="server-connection-spinner">üîå</div>
            <h2 id="serverConnectionHeading">Connecting...</h2>
            <p id="serverConnectionMessage"></p>
            <p class="server-connection-details" id="serverConnectionDetails"></p>
        </div>
    </div>

    <!-- Sync error overlay (shown when sync fails but credentials are valid) -->
    <div id="syncErrorOverlay" class="sync-error-overlay hidden">
        <div class="sync-error-content">
            <div class="sync-error-icon">‚ö†Ô∏è</div>
            <h2>Sync Failed</h2>
            <p id="syncErrorMessage">Unable to sync dataset</p>
            <div class="sync-error-actions">
                <button class="sync-error-btn primary" onclick="viewer.retrySyncFromError()">Retry</button>
                <button class="sync-error-btn" onclick="viewer.showConfigModal()">Update Credentials</button>
            </div>
        </div>
    </div>

    <!-- Full-screen canvas for video -->
    <canvas id="canvas"></canvas>
    <!-- Overlay canvas for mask (stacked on top) -->
    <canvas id="overlayCanvas"></canvas>
    <!-- Empty frame glow indicator (positioned to match image) -->
    <div id="emptyFrameGlow"></div>

    <!-- Brush size preview circle -->
    <div id="brushPreview" class="brush-preview"></div>

    <!-- Left toolbar -->
    <div class="toolbar-left" id="toolbarLeft">
        <button class="tool-btn warning" id="markEmpty" title="Mark Empty">üö´</button>
        <button class="tool-btn" id="eraseMode" title="Erase">üßΩ</button>
        <button class="tool-btn active" id="drawMode" title="Draw">üñåÔ∏è</button>
        <button class="tool-btn" id="toggleMask" title="Toggle Mask">ü•∏</button>
        <div class="slider-spacer"></div>
        <div class="slider-group-vertical">
            <div class="slider-indicator-top">‚óè</div>
            <input type="range" id="brushSizeInline" min="5" max="50" value="15" orient="vertical">
            <div class="slider-indicator-bottom">‚óè</div>
        </div>
    </div>

    <!-- Right toolbar -->
    <div class="toolbar-right" id="toolbarRight">
        <div class="control-badge clickable" id="examBadge" title="Click to select series"># --</div>
        <button class="control-btn" id="markComplete" title="Mark Complete & Get Next Series">‚úÖ</button>
        <button class="control-btn" id="infoBtn" title="Info">‚ÑπÔ∏è</button>
        <button class="control-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        <button class="control-btn" id="resetMask" title="Reset">‚Ü∫</button>
    </div>

    <!-- Bottom toolbar -->
    <div class="toolbar-bottom" id="toolbarBottom">
        <div class="bottom-bar-controls">
            <button class="playback-btn" id="playPause" title="Play/Pause">‚ñ∂Ô∏è</button>
            <button class="playback-btn" id="prevFrame" title="Previous Frame">‚èÆ</button>
            <button class="playback-btn" id="nextFrame" title="Next Frame">‚è≠</button>
        </div>
        <div class="bottom-bar-slider">
            <div class="slider-wrapper">
                <span class="slider-label" id="sliderMin">0</span>
                <canvas id="sliderTypeBar" class="slider-type-bar"></canvas>
                <input type="range" id="frameSlider" min="0" max="100" value="0">
                <span class="slider-label" id="sliderMax">0</span>
            </div>
        </div>
        <div class="bottom-bar-save">
            <button class="tool-btn" id="saveChanges" title="Save (automatically triggers retrack)">üíæ</button>
            <div class="frame-counter" id="frameCounter">0 / 0</div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal" id="infoModal">
        <div class="modal-content">
            <button class="modal-close" id="closeInfo">‚úï</button>
            <h2>Video Info</h2>
            <div class="info-section">
                <p><strong>Method:</strong> <span id="infoMethod">{{ selected_video.method }}</span></p>
                <p><strong>Exam:</strong> <span id="infoExam">{{ selected_video.exam_number }}</span></p>
                <p><strong>Study:</strong> <span id="infoStudy" class="monospace">{{ selected_video.study_uid }}</span></p>
                <p><strong>Series:</strong> <span id="infoSeries" class="monospace">{{ selected_video.series_uid }}</span></p>
            </div>

            <h3>Current Frame</h3>
            <div class="info-section">
                <p><strong>Frame:</strong> <span id="frameInfo">0 / 0</span></p>
                <p><strong>Type:</strong> <span id="frameType">-</span></p>
                <p><strong>Label:</strong> <span id="frameLabelId" class="monospace">-</span></p>
                <p><strong>Modified:</strong> <span id="frameModified">No</span></p>
            </div>

            <h3>Color Guide</h3>
            <div class="info-section">
                <div class="label-item">
                    <span class="color-box" style="background: rgba(0, 255, 0, 0.5);"></span>
                    <span>Human annotation (LABEL_ID)</span>
                </div>
                <div class="label-item">
                    <span class="color-box" style="background: rgba(255, 165, 0, 0.5);"></span>
                    <span>Tracking prediction (TRACK_ID)</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>Advanced</h3>
                <button class="modal-btn warning" id="resetRetrackBtn" style="width: 100%; margin-top: 10px;">
                    üîÑ Reset Retrack Data (Current Series)
                </button>
                <button class="modal-btn warning" id="resetRetrackAllBtn" style="width: 100%; margin-top: 10px;">
                    üîÑ Reset Retrack Data (All Series)
                </button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="keyboardShortcutsModal">
        <div class="modal-content">
            <button class="modal-close" id="closeKeyboardShortcuts">‚úï</button>
            <h2>Keyboard Shortcuts</h2>
            <div class="info-section">
                <div class="shortcuts">
                    <div><kbd>Space</kbd> Play/Pause</div>
                    <div><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate frames</div>
                    <div><kbd>D</kbd> Draw mode</div>
                    <div><kbd>E</kbd> Erase mode</div>
                    <div><kbd>‚åòS</kbd> Save changes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="modal-close" id="closeSettings">‚úï</button>
            <h2>Settings</h2>
            <div class="info-section settings-form">
                <label for="settingsEmail">Your Name</label>
                <select id="settingsEmail">
                    <option value="" disabled>Select your name...</option>
                    <option value="Aaron">Aaron</option>
                    <option value="Christopher">Christopher</option>
                    <option value="Faezeh">Faezeh</option>
                    <option value="Kush">Kush</option>
                    <option value="Newton">Newton</option>
                </select>
                <label for="settingsToken">MD.ai API Token</label>
                <input type="password" id="settingsToken" placeholder="Set or update token">
                <p class="muted">Leave token blank to keep the current token. Token is saved persistently.</p>
                <div class="token-status" id="tokenStatus">Token: unknown</div>
                <div class="settings-actions">
                    <button class="control-btn" id="saveSettings" title="Save Settings">üíæ</button>
                    <button class="control-btn" id="resyncDataset" title="Resync Dataset">üîÑ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Series Selection Modal (opened from exam badge) -->
    <div class="modal" id="seriesSelectModal">
        <div class="modal-content">
            <button class="modal-close" id="closeSeriesSelect">‚úï</button>
            <h2>Select Series</h2>

            <div class="nav-section">
                <select id="videoSelect" class="video-select">
                    {% for video in videos|sort(attribute='exam_number') %}
                    <option value="{{ video.method }}|{{ video.study_uid }}|{{ video.series_uid }}"
                            {% if video == selected_video %}selected{% endif %}>
                        ‚óªÔ∏è Exam {{ video.exam_number }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Completion confirmation modal -->
    <div class="modal" id="completeModal">
        <div class="modal-content">
            <button class="modal-close" id="closeComplete">‚úï</button>
            <h2>Mark series as done?</h2>
            <div class="info-section">
                <p>This will remove the current series from normal rotation.</p>
                <p>You can reopen it later if needed.</p>
            </div>
            <div class="button-row">
                <button class="modal-btn" id="confirmComplete">‚úÖ Mark Done</button>
                <button class="modal-btn" id="cancelComplete">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Conflict modal (version mismatch or retrack in progress) -->
    <div class="modal" id="conflictModal">
        <div class="modal-content">
            <button class="modal-close" id="closeConflict">‚úï</button>
            <h2 id="conflictTitle">Save Conflict</h2>
            <div class="info-section">
                <p id="conflictMessage"></p>
                <div id="conflictDetails" class="monospace" style="font-size: 0.9em; margin-top: 10px; color: #666;"></div>
            </div>
            <div class="button-row">
                <button class="modal-btn warning" id="resetAndReload">üîÑ Reset & Reload</button>
                <button class="modal-btn" id="cancelConflict">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reset retrack confirmation modal -->
    <div class="modal" id="resetRetrackModal">
        <div class="modal-content">
            <button class="modal-close" id="closeResetRetrack">‚úï</button>
            <h2>Reset Retrack Data?</h2>
            <div class="info-section">
                <p><strong>This will permanently remove:</strong></p>
                <ul style="text-align: left; margin: 15px 0;">
                    <li>All retracked masks and data</li>
                    <li>Retrack queue jobs for this series</li>
                    <li>Version history (resets to initial tracking)</li>
                    <li>Uploaded mask archives</li>
                </ul>
                <p style="color: #ff9800; font-weight: bold;">This action cannot be undone!</p>
            </div>
            <div class="button-row">
                <button class="modal-btn warning" id="confirmResetRetrack">üîÑ Reset</button>
                <button class="modal-btn" id="cancelResetRetrack">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Reset all retrack confirmation modal -->
    <div class="modal" id="resetRetrackAllModal">
        <div class="modal-content">
            <button class="modal-close" id="closeResetRetrackAll">‚úï</button>
            <h2>Reset Retrack Data for ALL Series?</h2>
            <div class="info-section">
                <p><strong>This will permanently remove for ALL series:</strong></p>
                <ul style="text-align: left; margin: 15px 0;">
                    <li>All retracked masks and data</li>
                    <li>All retrack queue jobs</li>
                    <li>All version history (resets to initial tracking)</li>
                    <li>All uploaded mask archives</li>
                </ul>
                <p style="color: #ff9800; font-weight: bold;">This action cannot be undone!</p>
            </div>
            <div class="button-row">
                <button class="modal-btn warning" id="confirmResetRetrackAll">üîÑ Reset All</button>
                <button class="modal-btn" id="cancelResetRetrackAll">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Blocking loading overlay for retrack operations -->
    <div class="modal" id="retrackLoadingModal" style="z-index: 10000; background: rgba(0, 0, 0, 0.85);">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none; max-width: 300px;">
            <div class="retrack-loading-content">
                <div class="hourglass-container">
                    <div class="hourglass">‚è≥</div>
                </div>
                <div class="retrack-loading-text" id="retrackLoadingText">Processing retrack...</div>
            </div>
        </div>
    </div>

    <script>
        const INITIAL_VIDEO = {
            method: '{{ selected_video.method }}',
            studyUid: '{{ selected_video.study_uid }}',
            seriesUid: '{{ selected_video.series_uid }}'
        };
        const SERVER_URL = '{{ server_url }}';
        const CLIENT_URL = 'http://localhost:8080';
        // Cloudflare headers (injected by bundle script from dot.yaml cloudflare_headers)
        const CF_ACCESS_CLIENT_ID = "";
        const CF_ACCESS_CLIENT_SECRET = "";
    </script>
    <script src="/static/js/viewer.js"></script>
</body>
</html>
