# Goobusters Tasks

## To Do

- [ ] Jumpy video in annotation editor app but not in tracked_video.mp4? Example: 1.2.826.0.1.3680043.8.498.12762211632497404572246503032980657292_1.2.826.0.1.3680043.8.498.90262783102403545676047413537747709850
- [ ] Retrack progress by frame (seems mocked right now)
- [ ] Retrack remove modal interrupts
- [ ] Retrack on Save
- [ ] Combine (i) and video button
- [ ] Change revert button behavior? Revert to mdai? Or last saved?
- [ ] Indicator for verified empty frames (EMPTY_ID)
- [ ]Ensure we are consistently using 0-based frame counting, to be consistent with mdai json
- [ ] Multi-player? Worry about caching
- [ ] Fix brush size preview location (shouldn't move during resize previews)
  - [ ] Validate "No Fluid" frame annotation compatible with mdai json syntax. Example (frameNumber 0 (`"id": "A_gp58a1"`) & 41 (`"id": "A_AYxjY2"`) of 143, 0-based counting)"
  - StudyInstanceUID = "1.2.826.0.1.3680043.8 498. 21582572478922879563110991046360588727"
  - SeriesInstranceUID = "1.2.826.0.1.3680043.8.498.88798124921994953570699988775039906436"
- [ ] Local annotaion feedback loop? See references/teef for simpler example app with single annotation type
  - Server for reviewing/modifying annotations (LABEL_ID, EMPTY_ID, and TRACK_ID)
  - Save human reviewed/modified free fluid (LABEL_ID), no fluid (EMPTY_ID) annotations outside data/ bc data reflects mdai truth (maybe local db? duckdb with file?); may be better to store as masks (grayscale images) for local iterations, update annotation from masks on tracking runs (think this happens already but may need fixing)
  - Re-run tracking with locally updated annotations (LABEL_ID & EMPTY_ID annotations, no TRACK_ID; if in local db then don't source mdai annotations json)
  - Select model output if multiple subdirs exist in output/ ; if only one, select that one
  - Need to be able to scrub forward/backward by frame as well as "play" forward and backward
  - Need to be able to edit masks
  - Need to be able to "no fluid" a frame (remove TRACK_ID and LABEL_ID masks from frame, apply frame-level EMPTY_ID annotation)
  - Need to be able to switch to next/prev video
  - Need to be able to open list of videos to select from
  - New entrypoint, app.py, with separate library subdir for utility functions if needed.
  - Okay to rely on track.py lib/ functions; additional tracking functions should be made in lib/ (keep app and tracking in clear separation of concerns)
  - May need track.py to run before app can function (to fill in the tracking and make it available)

## Blocked

- [ ] (BLOCKED: REVISIT IF ANOTHER EXAMPLE ARISES) No LABEL_ID but still being included? 1.2.826.0.1.3680043.8.498.90435151582213456262290795805216481896_1.2.826.0.1.3680043.8.498.37052967828633660121479146607377040574
- [ ] (BLOCKED: NEED TO CREATE EMPTY FRAME ANNOTATIONS) Check `tracked_annotations` generated by tracking
- [ ] (BLOCKED: NEEDS PRIORITIZATION GO/NO-GO) lib/debug_visualization.py abandoned. If needed, will will have to fix debug viz and reincorporate
- [ ] (BLOCKED: NEED TEAM TO WEIGH IN ON METHODS) Send test annotations back to mdai for the Pelvic-1 dataset (MUST BE PELVIC-1 FOR TESTING, CHECK dot.env VARS TWICE)

## Done

- [x] lib/optical.py cleanup - 1998 lines but only 2 exported functions used (create_identity_file, copy_annotations_to_output). Consider refactoring or removing dead code.
  - lib/optical.py - 90% dead code (1,800 of 1,998 lines)
    - Only 2 functions are actually used: create_identity_file and copy_annotations_to_output
    - Contains entire unused classes: OpticalFlowTracker (1,385 lines), MultiAnnotationProcessor (300 lines)
    - Can be reduced from 1,998 â†’ ~200 lines
    - combine with opticalflowprocessor
  - lib/multi_frame_tracker.py - 25% vestigial code (~250 lines)
    - 13+ instance variables initialized but never used (e.g., tracking_strategy_weight, feedback_loop_mode, tracks, track_id_counter)
    - 4 unused methods: \_track_forward, \_track_backward, \_get_previous_frame, `_get_next_frame`
    - Logger bugs: self.logger used but never initialized (will cause AttributeError)
  - lib/debug_visualization.py - 100% orphaned (242 lines)
    - Entire file unused, not imported anywhere
    - Should be deleted or moved to debug_tools/
  - lib/video_capture_manager.py - 61% unused (78 of 127 lines)
    - VideoCaptureManager class and read_frame_at_position() are unused
    - Only video_capture() and get_video_properties() are actually used
  - lib/opticalflowprocessor.py - 24% unused
    - apply_optical_flow() method defined but never called
- [x] Update mdai integration to ONLY pull the PROJECT_ID and DATASET_ID from dot.env (not all data from the project) `mdai_client.project(project_id=PROJECT_ID, dataset_id=DATASET_ID, path=DATA_DIR)` from <https://docs.md.ai/annotator/python/guides/general/>
- [x] Clean code and remove unused or overly complex bits in the current fork (incl. remove deepflow as too slow to be practical)
  - [x] Removed deepflow
  - [x] Removed temporal smoothing (unproven complexity)
  - [x] Removed unused files: parallel_processor.py, video_capture_manager.py, diagnose.py
- [x] Empty frame annotations (allow annotations for frames with no fluid in bidirectional tracking with EMPTY_ID from dot.env)
- [x] Jerky tracking? Tracking seems to jump frame-to-frame (noted, no changes made)
- [x] Performance tuning? Anything to be done with cpu vs gpu accel or parallelization? (reviewed, already optimized)
- [x] dot.env.example update for new/modified options (added TEST_STUDY_UID, TEST_SERIES_UID, improved comments)
- [x] `tracked_annotations` should include TRACK_ID, EMPTY_ID, and LABEL_ID (now uses actual environment variable values instead of hardcoded strings)
